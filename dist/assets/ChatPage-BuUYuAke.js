import{r as o,u as _,j as n,d as F,b as Y,a as z,A as q}from"./index-Bx6DPSim.js";import{a as H,b as O}from"./aiTutorService-D0WICzOD.js";import{M as G}from"./index-BTdfOqQp.js";const l=[];for(let e=0;e<256;++e)l.push((e+256).toString(16).slice(1));function W(e,t=0){return(l[e[t+0]]+l[e[t+1]]+l[e[t+2]]+l[e[t+3]]+"-"+l[e[t+4]]+l[e[t+5]]+"-"+l[e[t+6]]+l[e[t+7]]+"-"+l[e[t+8]]+l[e[t+9]]+"-"+l[e[t+10]]+l[e[t+11]]+l[e[t+12]]+l[e[t+13]]+l[e[t+14]]+l[e[t+15]]).toLowerCase()}let D;const Z=new Uint8Array(16);function J(){if(!D){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");D=crypto.getRandomValues.bind(crypto)}return D(Z)}const K=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),L={randomUUID:K};function Q(e,t,a){var i;e=e||{};const r=e.random??((i=e.rng)==null?void 0:i.call(e))??J();if(r.length<16)throw new Error("Random bytes length must be >= 16");return r[6]=r[6]&15|64,r[8]=r[8]&63|128,W(r)}function M(e,t,a){return L.randomUUID&&!e?L.randomUUID():Q(e)}const X=e=>{const[t,a]=o.useState([]),[r,i]=o.useState(!1),{language:p}=_(),g=o.useCallback(async c=>{if(!c.trim())return;const d={id:M(),text:c,sender:"user"};a(s=>[...s,d]),i(!0);try{const s=await H(c,e,p.name),x={id:M(),text:s,sender:"tutor"};a(h=>[...h,x])}catch(s){console.error("Failed to get response from tutor:",s);const x={id:M(),text:"Sorry, I'm having trouble connecting. Please try again.",sender:"tutor"};a(h=>[...h,x])}finally{i(!1)}},[e,p.name]);return{messages:t,loading:r,sendMessage:g}},ee=()=>n.jsxs("div",{className:"flex items-center space-x-1.5 p-3 rounded-lg",children:[n.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-pulse",style:{animationDelay:"0s"}}),n.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-pulse",style:{animationDelay:"0.1s"}}),n.jsx("div",{className:"w-2 h-2 bg-gray-400 rounded-full animate-pulse",style:{animationDelay:"0.2s"}})]});function te(e){let t="";const a=e.byteLength;for(let r=0;r<a;r++)t+=String.fromCharCode(e[r]);return btoa(t)}function ne(e){const t=atob(e),a=t.length,r=new Uint8Array(a);for(let i=0;i<a;i++)r[i]=t.charCodeAt(i);return r}async function re(e,t,a,r){const i=new Int16Array(e.buffer),p=i.length/r,g=t.createBuffer(r,p,a);for(let c=0;c<r;c++){const d=g.getChannelData(c);for(let s=0;s<p;s++)d[s]=i[s*r+c]/32768}return g}const B=16e3,V=24e3,se=4096,oe=e=>{const[t,a]=o.useState(!1),[r,i]=o.useState(!1),[p,g]=o.useState(""),c=o.useRef(null),d=o.useRef(null),s=o.useRef(null),x=o.useRef(null),h=o.useRef(null),S=o.useRef(null),m=o.useRef(new Set).current,v=o.useRef(0),R=o.useCallback(()=>{m.forEach(u=>{u.stop()}),m.clear(),v.current=0,i(!1)},[m]),w=o.useCallback(async()=>{if(!(!t&&!c.current)){if(a(!1),c.current)try{(await c.current).close()}catch(u){console.error("Error closing session:",u)}finally{c.current=null}h.current&&(h.current.disconnect(),h.current=null),S.current&&(S.current.disconnect(),S.current=null),x.current&&(x.current.getTracks().forEach(u=>u.stop()),x.current=null),d.current&&d.current.state!=="closed"&&await d.current.close().catch(u=>console.error("Error closing input context",u)),d.current=null,R()}},[t,R]),I=o.useCallback(async()=>{if(!t){g(""),a(!0);try{(!s.current||s.current.state==="closed")&&(s.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:V}));const u=s.current.createGain();u.connect(s.current.destination),(!d.current||d.current.state==="closed")&&(d.current=new(window.AudioContext||window.webkitAudioContext)({sampleRate:B}));const f=await navigator.mediaDevices.getUserMedia({audio:!0});x.current=f;const $={model:"gemini-2.5-flash-native-audio-preview-09-2025",config:{responseModalities:[G.AUDIO],inputAudioTranscription:{},systemInstruction:e},callbacks:{onopen:()=>{const y=d.current.createMediaStreamSource(f);S.current=y;const j=d.current.createScriptProcessor(se,1,1);h.current=j,j.onaudioprocess=T=>{const N=T.inputBuffer.getChannelData(0),A=N.length,k=new Int16Array(A);for(let b=0;b<A;b++)k[b]=N[b]*32768;const E={data:te(new Uint8Array(k.buffer)),mimeType:`audio/pcm;rate=${B}`};c.current&&c.current.then(b=>{b.sendRealtimeInput({media:E})})},y.connect(j),j.connect(d.current.destination)},onmessage:async y=>{var T,N,A,k,E,b;(T=y.serverContent)!=null&&T.interrupted&&R(),(N=y.serverContent)!=null&&N.inputTranscription&&g(y.serverContent.inputTranscription.text),(A=y.serverContent)!=null&&A.turnComplete&&g("");const j=(b=(E=(k=y.serverContent)==null?void 0:k.modelTurn)==null?void 0:E.parts[0])==null?void 0:b.inlineData.data;if(j){i(!0);const U=s.current;v.current=Math.max(v.current,U.currentTime);const P=await re(ne(j),U,V,1),C=U.createBufferSource();C.buffer=P,C.connect(u),C.addEventListener("ended",()=>{m.delete(C),m.size===0&&i(!1)}),C.start(v.current),v.current+=P.duration,m.add(C)}},onerror:y=>{console.error("Live session error:",y),w()},onclose:y=>{t&&w()}}};c.current=O.live.connect($)}catch(u){console.error("Failed to start voice chat:",u),a(!1)}}},[t,w,R,e,m]);return o.useEffect(()=>()=>{w(),s.current&&s.current.state!=="closed"&&s.current.close().catch(u=>console.error("Error closing output context",u))},[w]),{isRecording:t,isSpeaking:r,transcript:p,startRecording:I,stopRecording:w}},ue=()=>{const{subject:e}=F(),t=Y(),{user:a,addBadge:r}=z(),{language:i}=_(),p=e?decodeURIComponent(e):"",{messages:g,loading:c,sendMessage:d}=X(p),[s,x]=o.useState(""),h=o.useRef(null),S=`You are Naija AI Tutor, an intelligent, friendly, and patient Nigerian teacher. You explain complex topics simply, using local examples and pidgin English where appropriate to make learning relatable and fun for Nigerian students. The current topic is ${p}. Your tone should be encouraging and supportive. You must respond only in ${i.name}.`,{isRecording:m,isSpeaking:v,transcript:R,startRecording:w,stopRecording:I}=oe(S);o.useEffect(()=>{a||t("/login")},[a,t]),o.useEffect(()=>{g.length>0&&g.some(f=>f.sender==="user")&&a&&r("Curious Mind")},[g,a,r]),o.useEffect(()=>{var f;(f=h.current)==null||f.scrollIntoView({behavior:"smooth"})},[g,c]);const u=f=>{f.preventDefault(),d(s),x("")};return a?n.jsxs("div",{className:"flex flex-col h-screen bg-gray-100",children:[n.jsxs("header",{className:"bg-white shadow-md sticky top-0 z-10 flex items-center p-4",children:[n.jsx("button",{onClick:()=>t("/dashboard"),className:"p-2 mr-2 rounded-full hover:bg-gray-200",children:n.jsx(q,{className:"w-6 h-6 text-gray-700"})}),n.jsx("h1",{className:"text-xl font-bold text-gray-800",children:p})]}),n.jsxs("main",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[g.map(f=>n.jsx("div",{className:`flex ${f.sender==="user"?"justify-end":"justify-start"}`,children:n.jsx("div",{className:`max-w-lg p-3 rounded-lg ${f.sender==="user"?"bg-green-500 text-white":"bg-white text-gray-800 shadow-sm"}`,children:f.text})},f.id)),c&&n.jsx("div",{className:"flex justify-start",children:n.jsx("div",{className:"bg-white p-3 rounded-lg shadow-sm",children:n.jsx(ee,{})})}),n.jsx("div",{ref:h})]}),n.jsxs("footer",{className:"bg-white border-t p-4",children:[m&&n.jsxs("div",{className:"text-center text-sm text-gray-600 mb-2 p-2 bg-gray-100 rounded-md",children:[R?n.jsxs("em",{children:['"',R,'"']}):"Listening...",v&&n.jsx("span",{className:"ml-2 animate-pulse",children:"Tutor is speaking..."})]}),n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsxs("form",{onSubmit:u,className:"flex-1 flex items-center",children:[n.jsx("input",{type:"text",value:s,onChange:f=>x(f.target.value),placeholder:"Ask a question...",className:"w-full p-3 border border-gray-300 rounded-l-md focus:ring-green-500 focus:border-green-500",disabled:m}),n.jsx("button",{type:"submit",className:"px-4 py-3 bg-green-600 text-white rounded-r-md hover:bg-green-700 disabled:bg-gray-400",disabled:c||!s.trim()||m,children:"Send"})]}),n.jsx("button",{onClick:m?I:w,className:`p-3 rounded-full transition-colors ${m?"bg-red-500 text-white animate-pulse":"bg-gray-200 text-gray-700"}`,children:n.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:n.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"})})})]})]})]}):null};export{ue as default};
